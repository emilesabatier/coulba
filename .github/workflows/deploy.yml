name: Deploy

on:
    release:
        types: [published]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    deploy-image:

        runs-on: ubuntu-22.04

        permissions:
            contents: read
            packages: write

        steps:
            -   name: Deploy the new images
                uses: appleboy/ssh-action@v1.0.3
                with:
                    host: ${{ secrets.SSH_HOST }}
                    username: ${{ secrets.SSH_USERNAME }}
                    password: ${{ secrets.SSH_PASSWORD }}
                    script: |
                        cd ~/coulba
                        docker stack deploy -c compose.website.yml --with-registry-auth coulba
                        docker stack deploy -c compose.api.yml --with-registry-auth coulba
                        docker stack deploy -c compose.app.yml --with-registry-auth coulba
